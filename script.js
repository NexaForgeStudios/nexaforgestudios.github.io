/*************************
 * Translations system
 *************************/
const translations = {
  fr: {
    nav: {
      games: "Jeux",
      news: "Actualités",
      support: "Support",
      shop: "Boutique",
      login: "Connexion",
      logout: "Déconnexion",
      myAccount: "Mon compte"
    },
    hero: {
      discoverGame: "Découvrir le jeu",
      discord: "Discord",
      deadlineProtocolDesc: "Un jeu où vous incarnez un jeune lycéen qui doit accomplir des missions données par un étrange scientifique afin de rembourser les dettes de sa mère.",
      nothingSubtitle: "Rien",
      nothingTitle: "Rien",
      btnNothing: "Rien",
    },
    sections: {
      games: "JEUX",
      news: "ACTUALITÉS"
    },
    games: {
      deadlineProtocol: "Deadline Protocol",
      inDevelopment: "En développement...",
      findOutMore: "En savoir plus",
      nothing: "Rien"
    },
    news: {
      nothing: "Rien"
    },
    footer: {
      games: "Jeux",
      services: "Services",
      enterprise: "Entreprise",
      community: "Communauté",
      about: "À propos",
      careers: "Carrières",
      contact: "Contact",
      twitter: "Twitter",
      youtube: "YouTube",
      discord: "Discord",
      copyright: "© 2025 NexaForge Studios, Inc. Tous droits réservés."
    },
    auth: {
      loginSignup: "Connexion / Inscription",
      email: "Email",
      password: "Mot de passe",
      login: "Connexion",
      signup: "S'inscrire",
      noAccount: "Je n'ai pas de compte · S'inscrire",
      hasAccount: "J'ai déjà un compte · Se connecter",
      connectWith: "ou se connecter avec",
      google: "Google",
      apple: "Apple",
      epic: "Epic Games",
      xbox: "Xbox / Microsoft",
      playstation: "PlayStation",
      emailPasswordRequired: "Email et mot de passe requis.",
      loginError: "Erreur de connexion : ",
      signupError: "Erreur d'inscription : ",
      googleError: "Erreur Google : ",
      appleError: "Erreur Apple : ",
      epicError: "L'authentification Epic Games nécessite une configuration OAuth personnalisée. Veuillez contacter le support.",
      xboxError: "Erreur Xbox/Microsoft : ",
      psError: "L'authentification PlayStation nécessite une configuration OAuth personnalisée. Veuillez contacter le support.",
      loginSuccess: "Connexion réussie pour",
      signupSuccess: "Inscription réussie pour"
    },
    carousel: {
      goToSlide: "Aller à la diapositive",
      nothing: "Rien"
    }
  },
  en: {
    nav: {
      games: "Games",
      news: "News",
      support: "Support",
      shop: "Store",
      login: "Log in",
      logout: "Log out",
      myAccount: "My Account"
    },
    hero: {
      discoverGame: "Discover the game",
      discord: "Discord",
      deadlineProtocolDesc: "A game where you play as a high school student completing missions for a mysterious scientist to pay off your mother’s debts.",
      nothingSubtitle: "Nothing",
      nothingTitle: "Nothing",
      btnNothing: "Nothing",
    },
    sections: {
      games: "GAMES",
      news: "NEWS"
    },
    games: {
      deadlineProtocol: "Deadline Protocol",
      inDevelopment: "In development...",
      findOutMore: "Learn more",
      nothing: "Nothing"
    },
    news: {
      nothing: "Nothing"
    },
    footer: {
      games: "Games",
      services: "Services",
      enterprise: "Company",
      community: "Community",
      about: "About",
      careers: "Careers",
      contact: "Contact",
      twitter: "Twitter",
      youtube: "YouTube",
      discord: "Discord",
      copyright: "© 2025 NexaForge Studios, Inc. All rights reserved."
    },
    auth: {
      loginSignup: "Log in / Sign up",
      email: "Email",
      password: "Password",
      login: "Log in",
      signup: "Sign up",
      noAccount: "Don't have an account? · Sign up",
      hasAccount: "Already have an account? · Log in",
      connectWith: "or connect with",
      google: "Google",
      apple: "Apple",
      epic: "Epic Games",
      xbox: "Xbox / Microsoft",
      playstation: "PlayStation",
      emailPasswordRequired: "Email and password required.",
      loginError: "Login error: ",
      signupError: "Sign-up error: ",
      googleError: "Google error: ",
      appleError: "Apple error: ",
      epicError: "Epic Games authentication requires a custom OAuth setup. Please contact support.",
      xboxError: "Xbox/Microsoft error: ",
      psError: "PlayStation authentication requires a custom OAuth setup. Please contact support.",
      loginSuccess: "Login successful for",
      signupSuccess: "Sign-up successful for"
    },
    carousel: {
      goToSlide: "Go to slide",
      nothing: "Nothing"
    }
  },
  de: {
    nav: {
      games: "Spiele",
      news: "Neuigkeiten",
      support: "Support",
      shop: "Shop",
      login: "Anmelden",
      logout: "Abmelden",
      myAccount: "Mein Konto"
    },
    hero: {
      discoverGame: "Spiel entdecken",
      discord: "Discord",
      deadlineProtocolDesc: "Ein Spiel, in dem du einen Schüler spielst, der Missionen für einen mysteriösen Wissenschaftler erledigen muss, um die Schulden seiner Mutter zu begleichen.",
      nothingSubtitle: "Nichts",
      nothingTitle: "Nichts",
      btnNothing: "Nichts",
    },
    sections: {
      games: "SPIELE",
      news: "NEWS"
    },
    games: {
      deadlineProtocol: "Deadline Protocol",
      inDevelopment: "In Entwicklung...",
      findOutMore: "Mehr erfahren",
      nothing: "Nichts"
    },
    news: {
      nothing: "Nichts"
    },
    footer: {
      games: "Spiele",
      services: "Dienste",
      enterprise: "Unternehmen",
      community: "Community",
      about: "Über uns",
      careers: "Karriere",
      contact: "Kontakt",
      twitter: "Twitter",
      youtube: "YouTube",
      discord: "Discord",
      copyright: "© 2025 NexaForge Studios, Inc. Alle Rechte vorbehalten."
    },
    auth: {
      loginSignup: "Anmelden / Registrieren",
      email: "E-Mail",
      password: "Passwort",
      login: "Anmelden",
      signup: "Registrieren",
      noAccount: "Kein Konto? · Registrieren",
      hasAccount: "Schon ein Konto? · Einloggen",
      connectWith: "oder verbinden mit",
      google: "Google",
      apple: "Apple",
      epic: "Epic Games",
      xbox: "Xbox / Microsoft",
      playstation: "PlayStation",
      emailPasswordRequired: "E-Mail und Passwort erforderlich.",
      loginError: "Login-Fehler: ",
      signupError: "Registrierungsfehler: ",
      googleError: "Google-Fehler: ",
      appleError: "Apple-Fehler: ",
      epicError: "Epic Games-Login benötigt eine individuelle OAuth-Konfiguration. Bitte Support kontaktieren.",
      xboxError: "Xbox/Microsoft-Fehler: ",
      psError: "PlayStation-Login benötigt eine individuelle OAuth-Konfiguration. Bitte Support kontaktieren.",
      loginSuccess: "Login erfolgreich für",
      signupSuccess: "Registrierung erfolgreich für"
    },
    carousel: {
      goToSlide: "Zur Folie",
      nothing: "Nichts"
    }
  },
  ru: {
    nav: {
      games: "Игры",
      news: "Новости",
      support: "Поддержка",
      shop: "Магазин",
      login: "Войти",
      logout: "Выйти",
      myAccount: "Мой аккаунт"
    },
    hero: {
      discoverGame: "Открыть игру",
      discord: "Discord",
      deadlineProtocolDesc: "Игра, где вы играете за школьника, выполняющего задания таинственного учёного, чтобы выплатить долги своей матери.",
      nothingSubtitle: "Ничего",
      nothingTitle: "Ничего",
      btnNothing: "Ничего",
    },
    sections: {
      games: "ИГРЫ",
      news: "НОВОСТИ"
    },
    games: {
      deadlineProtocol: "Deadline Protocol",
      inDevelopment: "В разработке...",
      findOutMore: "Узнать больше",
      nothing: "Ничего"
    },
    news: {
      nothing: "Ничего"
    },
    footer: {
      games: "Игры",
      services: "Сервисы",
      enterprise: "Компания",
      community: "Сообщество",
      about: "О нас",
      careers: "Карьера",
      contact: "Контакты",
      twitter: "Twitter",
      youtube: "YouTube",
      discord: "Discord",
      copyright: "© 2025 NexaForge Studios, Inc. Все права защищены."
    },
    auth: {
      loginSignup: "Войти / Зарегистрироваться",
      email: "Email",
      password: "Пароль",
      login: "Войти",
      signup: "Регистрация",
      noAccount: "Нет аккаунта? · Зарегистрироваться",
      hasAccount: "Уже есть аккаунт? · Войти",
      connectWith: "или войти через",
      google: "Google",
      apple: "Apple",
      epic: "Epic Games",
      xbox: "Xbox / Microsoft",
      playstation: "PlayStation",
      emailPasswordRequired: "Нужны email и пароль.",
      loginError: "Ошибка входа: ",
      signupError: "Ошибка регистрации: ",
      googleError: "Ошибка Google: ",
      appleError: "Ошибка Apple: ",
      epicError: "Epic Games требует индивидуальную настройку OAuth. Свяжитесь с поддержкой.",
      xboxError: "Ошибка Xbox/Microsoft: ",
      psError: "PlayStation требует индивидуальную настройку OAuth. Свяжитесь с поддержкой.",
      loginSuccess: "Успешный вход для",
      signupSuccess: "Успешная регистрация для"
    },
    carousel: {
      goToSlide: "Перейти к слайду",
      nothing: "Ничего"
    }
  },
  zh: {
    nav: {
      games: "游戏",
      news: "新闻",
      support: "支持",
      shop: "商店",
      login: "登录",
      logout: "退出",
      myAccount: "我的账号"
    },
    hero: {
      discoverGame: "探索游戏",
      discord: "Discord",
      deadlineProtocolDesc: "一款游戏，你将扮演一名高中生，接受神秘科学家的任务来偿还母亲的债务。",
      nothingSubtitle: "无",
      nothingTitle: "无",
      btnNothing: "无",
    },
    sections: {
      games: "游戏",
      news: "新闻"
    },
    games: {
      deadlineProtocol: "Deadline Protocol",
      inDevelopment: "开发中...",
      findOutMore: "了解更多",
      nothing: "无"
    },
    news: {
      nothing: "无"
    },
    footer: {
      games: "游戏",
      services: "服务",
      enterprise: "企业",
      community: "社区",
      about: "关于我们",
      careers: "招聘",
      contact: "联系我们",
      twitter: "Twitter",
      youtube: "YouTube",
      discord: "Discord",
      copyright: "© 2025 NexaForge Studios, Inc. 版权所有."
    },
    auth: {
      loginSignup: "登录 / 注册",
      email: "邮箱",
      password: "密码",
      login: "登录",
      signup: "注册",
      noAccount: "没有账号？· 注册",
      hasAccount: "已有账号？· 登录",
      connectWith: "或使用以下方式登录",
      google: "Google",
      apple: "Apple",
      epic: "Epic Games",
      xbox: "Xbox / Microsoft",
      playstation: "PlayStation",
      emailPasswordRequired: "需要邮箱和密码。",
      loginError: "登录错误：",
      signupError: "注册错误：",
      googleError: "Google 错误：",
      appleError: "Apple 错误：",
      epicError: "Epic Games 登录需要自定义 OAuth 配置。请联系支持。",
      xboxError: "Xbox/Microsoft 错误：",
      psError: "PlayStation 登录需要自定义 OAuth 配置。请联系支持。",
      loginSuccess: "登录成功：",
      signupSuccess: "注册成功："
    },
    carousel: {
      goToSlide: "跳转到幻灯片",
      nothing: "无"
    }
  }
};


function getTranslation(key, lang = currentLanguage) {
  const keys = key.split('.');
  let value = translations[lang];
  for (const k of keys) {
    value = value?.[k];
  }
  return value || key;
}

let currentLanguage = 'fr';

function applyTranslations() {
  document.querySelectorAll('[data-translate]').forEach(element => {
    const key = element.getAttribute('data-translate');
    element.textContent = getTranslation(key);
  });

  document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
    const key = element.getAttribute('data-translate-placeholder');
    element.placeholder = getTranslation(key);
  });

  document.querySelectorAll('.indicator').forEach((indicator, index) => {
    indicator.setAttribute('aria-label', getTranslation('carousel.goToSlide') + ' ' + (index + 1));
  });
}

document.getElementById('language-select').addEventListener('change', (e) => {
  currentLanguage = e.target.value;
  applyTranslations();
});

/*************************
 * Basic functionality
 *************************/
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
  anchor.addEventListener('click', function (e) {
    e.preventDefault();
    const target = document.querySelector(this.getAttribute('href'));
    if (target) {
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
});

const observerOptions = { threshold: 0.1, rootMargin: '0px 0px -50px 0px' };
const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('visible'); });
}, observerOptions);
document.querySelectorAll('.fade-in').forEach(el => observer.observe(el));

window.addEventListener('scroll', () => {
  const header = document.querySelector('.header');
  if (window.scrollY > 100) header.style.background = 'rgba(0, 0, 0, 0.95)';
  else header.style.background = 'rgba(0, 0, 0, 0.9)';
});

const hamburger = document.getElementById('hamburger');
const navMenu = document.getElementById('nav-menu');
hamburger.addEventListener('click', () => {
  const expanded = hamburger.getAttribute('aria-expanded') === 'true';
  hamburger.setAttribute('aria-expanded', String(!expanded));
  navMenu.classList.toggle('active');
});

/*************************
 * Carousel logic
 *************************/
const slides = Array.from(document.querySelectorAll('.carousel-slide'));
const indicatorsWrapper = document.getElementById('carousel-indicators');
let current = 0;
let autoPlayTimer = null;

slides.forEach((_, i) => {
  const dot = document.createElement('div');
  dot.className = 'indicator' + (i === 0 ? ' active' : '');
  dot.setAttribute('data-index', String(i));
  dot.setAttribute('role', 'button');
  dot.setAttribute('aria-label', getTranslation('carousel.goToSlide') + ' ' + (i + 1));
  indicatorsWrapper.appendChild(dot);
});
const indicators = Array.from(indicatorsWrapper.children);

function goToSlide(n) {
  if (n === current) return;
  slides.forEach((s, i) => {
    s.classList.remove('active', 'prev');
    if (i < n) s.classList.add('prev');
  });
  slides[current].classList.remove('active');
  slides[n].classList.add('active');
  indicators.forEach(d => d.classList.remove('active'));
  indicators[n].classList.add('active');
  current = n;
}

indicators.forEach(dot => dot.addEventListener('click', (e) => {
  const idx = Number(dot.getAttribute('data-index'));
  goToSlide(idx);
  restartAutoPlay();
}));

function nextSlide() { goToSlide((current + 1) % slides.length); }
function restartAutoPlay() {
  if (autoPlayTimer) clearInterval(autoPlayTimer);
  autoPlayTimer = setInterval(nextSlide, 5000);
}
restartAutoPlay();

/*************************
 * Firebase Authentication
 *************************/
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  GoogleAuthProvider,
  signInWithPopup,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDmose-4Yja2ZIxjKXV9oWInF9dKFcYvYM",
  authDomain: "nexaforge-studios-66fbe.firebaseapp.com",
  projectId: "nexaforge-studios-66fbe",
  storageBucket: "nexaforge-studios-66fbe.firebasestorage.app",
  messagingSenderId: "296882687491",
  appId: "1:296882687491:web:4aeb4ef4557b61daf58836",
  measurementId: "G-7GJXYPMSZD"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const openAuth = document.getElementById('open-auth');
const authModal = document.getElementById('auth-modal');
const authClose = document.getElementById('auth-close');
const authEmail = document.getElementById('auth-email');
const authPassword = document.getElementById('auth-password');
const authAction = document.getElementById('auth-action');
const toggleAuthMode = document.getElementById('toggle-auth-mode');
const authMessage = document.getElementById('auth-message');

let mode = 'login';

function openModal() {
  authModal.style.display = 'flex';
  authModal.setAttribute('aria-hidden', 'false');
  authMessage.style.display = 'none';
}
function closeModal() {
  authModal.style.display = 'none';
  authModal.setAttribute('aria-hidden', 'true');
}

openAuth.addEventListener('click', (e) => { e.preventDefault(); openModal(); });
authClose.addEventListener('click', closeModal);
window.addEventListener('click', (e) => { if (e.target === authModal) closeModal(); });

toggleAuthMode.addEventListener('click', () => {
  if (mode === 'login') {
    mode = 'signup';
    authAction.textContent = getTranslation("auth.signup");
    toggleAuthMode.textContent = getTranslation("auth.hasAccount");
  } else {
    mode = 'login';
    authAction.textContent = getTranslation("auth.login");
    toggleAuthMode.textContent = getTranslation("auth.noAccount");
  }
  authMessage.style.display = 'none';
});

authAction.addEventListener('click', async () => {
  const email = authEmail.value.trim();
  const password = authPassword.value;
  authMessage.style.display = 'none';

  if (!email || !password) {
    authMessage.textContent = getTranslation("auth.emailPasswordRequired");
    authMessage.style.display = 'block';
    return;
  }

  try {
    let userCredential;
    if (mode === 'login') {
      userCredential = await signInWithEmailAndPassword(auth, email, password);
    } else {
      userCredential = await createUserWithEmailAndPassword(auth, email, password);
      await setDoc(doc(db, "users", userCredential.user.uid), {
        email: userCredential.user.email,
        createdAt: new Date().toISOString()
      });
    }
    onLoginSuccess(userCredential.user.email, mode === 'signup');
  } catch (err) {
    const errorKey = mode === 'login' ? 'auth.loginError' : 'auth.signupError';
    authMessage.textContent = getTranslation(errorKey) + (err.message || err);
    authMessage.style.display = 'block';
    console.error('Auth Error:', err);
  }
});

document.getElementById('btn-google').addEventListener('click', async () => {
  const provider = new GoogleAuthProvider();
  provider.addScope('profile');
  provider.addScope('email');

  try {
    const result = await signInWithPopup(auth, provider);

    await setDoc(doc(db, 'users', result.user.uid), {
      email: result.user.email,
      displayName: result.user.displayName,
      provider: 'google',
      lastLogin: new Date().toISOString()
    }, { merge: true });

    onLoginSuccess(result.user.email || result.user.displayName);
  } catch (err) {
    console.error('Google Auth Error:', err);
    authMessage.textContent = getTranslation("auth.googleError") + (err.message || err);
    authMessage.style.display = 'block';
  }
});

document.getElementById('btn-apple').addEventListener('click', () => {
  authMessage.textContent = "Apple authentication coming soon!";
  authMessage.style.display = 'block';
});

document.getElementById('btn-epic').addEventListener('click', () => {
  authMessage.textContent = getTranslation("auth.epicError");
  authMessage.style.display = 'block';
});

document.getElementById('btn-xbox').addEventListener('click', () => {
  authMessage.textContent = "Xbox/Microsoft authentication coming soon!";
  authMessage.style.display = 'block';
});

document.getElementById('btn-ps').addEventListener('click', () => {
  authMessage.textContent = getTranslation("auth.psError");
  authMessage.style.display = 'block';
});

function onLoginSuccess(email, isNew = false) {
  closeModal();
  const openAuthLink = document.getElementById('open-auth');
  openAuthLink.textContent = email ? (email.split('@')[0] || getTranslation('nav.myAccount')) : getTranslation('nav.myAccount');

  if (!document.getElementById('logout-link')) {
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.href = "#";
    a.id = "logout-link";
    a.textContent = getTranslation('nav.logout');
    a.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await signOut(auth);
        openAuthLink.textContent = getTranslation('nav.login');
        a.parentElement.remove();
        console.log('User logged out successfully');
      } catch (error) {
        console.error('Logout error:', error);
      }
    });
    document.querySelector('.nav-menu').appendChild(li).appendChild(a);
  }

  console.log((isNew ? getTranslation('auth.signupSuccess') : getTranslation('auth.loginSuccess')), email);
}

onAuthStateChanged(auth, user => {
  const openAuthLink = document.getElementById('open-auth');

  if (user) {
    openAuthLink.textContent = user.email ? user.email.split('@')[0] : (user.displayName || getTranslation('nav.myAccount'));

    if (!document.getElementById('logout-link')) {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = "#";
      a.id = "logout-link";
      a.textContent = getTranslation('nav.logout');
      a.addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          await signOut(auth);
          openAuthLink.textContent = getTranslation('nav.login');
          a.parentElement.remove();
        } catch (error) {
          console.error('Logout error:', error);
        }
      });
      document.querySelector('.nav-menu').appendChild(li).appendChild(a);
    }
  } else {
    openAuthLink.textContent = getTranslation('nav.login');

    const logoutLink = document.getElementById('logout-link');
    if (logoutLink) {
      logoutLink.parentElement.remove();
    }
  }
});

document.addEventListener('DOMContentLoaded', () => {
  applyTranslations();
});

applyTranslations();